---
title: "Analysis of Smoking Data (2011-2017)"
author: "Peter J. Ehmann"
date: "Due: 5/6/2019"
output: html_document
---

```{r setup, include = FALSE}
library(broom)
library(jsonlite)
library(knitr)
library(rvest)
library(tidyverse)
library(xml2)
opts_chunk$set(echo = FALSE)
```

<br>

# Part 1 - Acquire, clean, and format data (export as .csv).

<br>

#### You can retreive information about US state smoking data from the Centers for Disease Control (CDC) through the Socrata API. The JSON-formatted data for smoking rates by state from 2011-2017 can be accessed from https://chronicdata.cdc.gov/Survey-Data/Table-for-STATE-System-Current-Cigarette-Use-Among/xmxq-jxrr. There are a totoal of 371 JSON objects (rows) in the original dataset (53 states [includes DC, PR, GU] x 7 rows per state). A few columns of interest (renamed) are shown below. The smoking rate (%) and year are nested as 7x2 tibbles for each state.

```{r rates, warning = FALSE}
(
smoking_rates <- "https://chronicdata.cdc.gov/resource/gx47-p4ij.json" %>% 
  fromJSON() %>% 
  as_tibble() %>% 
  rename(state = locationdesc, abbr = locationabbr, year = year, percent = data_value) %>% 
  select(state, abbr, year, percent) %>% 
  group_by(state, abbr) %>% 
  nest(.key = smoking_rate) %>% 
  filter(abbr != "PR",
         abbr != "GU")
  )
```

<br>

#### You can retreive information about US state tobacco legislation (Cigarette - $ per pack) from 1995-2019 from the CDC through the Socrata API. Information about the dataset can be obtained at https://chronicdata.cdc.gov/Legislation/CDC-STATE-System-Tobacco-Legislation-Tax/2dwv-vfam. The data can be accessed as JSON and filtered before retrieving it since there are a total of 152,192 rows in the dataset. A few columns of interest (renamed) are shown below.

```{r tax}
(
tax <- paste0("https://chronicdata.cdc.gov/resource/7uzt-fasa.json?",  "Year=2011%20AND%20MeasureDesc=%27Cigarette%27%20OR%20Year=2017%20AND%20MeasureDesc=%27Cigarette%27") %>% 
  fromJSON() %>% 
  as_tibble() %>% 
  rename(state = locationdesc, tax_value = provisionvalue) %>% 
  filter(state %in% as_vector(smoking_rates[,1])) %>% 
  mutate(tax_value = as.numeric(tax_value)) %>% 
  select(state, year, tax_value) %>% 
  distinct() %>% 
  group_by(state, year) %>% 
  summarise(value = mean(tax_value)) %>% 
  spread(., year, value) %>% 
  rename(tax_2011 = `2011`, tax_2017 = `2017`) %>% 
  mutate(delta_tax = tax_2017 - tax_2011)
  )
```

<br>

#### Information about US state region classifications can be scraped from the main list in the HTML of https://simple.wikipedia.org/wiki/List_of_regions_of_the_United_States. The div, ul, and il tags can be used to extract each state's region and division (sub-region).

```{r scrape_wiki_html}
(
states_html <- read_html("https://simple.wikipedia.org/wiki/List_of_regions_of_the_United_States")
  )

states <- states_html %>% 
  html_nodes(xpath = "//div/ul/li/ul/li/ul/li") %>% 
  html_text()

divisions <- states_html %>% 
  html_nodes(xpath = "//div/div/div/div/ul/li/ul/li") %>% 
  html_text()

regions <- states_html %>% 
  html_nodes(xpath = "//div/div/div/div/ul/li") %>% 
  html_text()
```

```{r extract_division}
division_names <- divisions %>% 
  str_extract(., "\\((.*)\\)") %>% 
  str_extract(., "[\\w+\\s?]+")

division_counts <- divisions %>% 
  str_count(., "\n")

division_list = ""
for (i in 1:length(division_names)) {
  division_list <- c(division_list, (rep(division_names[i], division_counts[i])))
}
```

```{r extract_region}
region_names <- regions %>% 
  .[1:4] %>% 
  str_extract(., "\\((.*)\\)") %>% 
  str_extract(., "[\\w+\\s?]+")

region_counts <- regions %>% 
  .[1:4] %>% 
  str_count(., "\n")

divisions_per_region <- regions %>% 
  .[1:4] %>% 
  str_count(., "Division")

region_list = ""
for (i in 1:length(region_names)) {
  region_list <- c(region_list, (rep(region_names[i], region_counts[i]-divisions_per_region[i])))
}
```

```{r states_table}
state_table <- as_tibble(data.frame(matrix(nrow = length(states), ncol = 3)))
colnames(state_table) <- c("state", "region", "division")
state_table[,1] <- states
state_table[,2] <- region_list[-1]
state_table[,3] <- division_list[-1]
state_table %>% arrange(state)
```

<br>

#### The datasets are merged by STATE and the nested tibbles are unnested.

```{r merge_data}
df_clean <- merge(smoking_rates, tax, by = "state") %>% 
  merge(., state_table, by = "state") %>% 
  unnest()
```

#### The last step is to export the data as a .csv file which is posted in the GitHub repository.

```{r write_csv}
# uncomment the second line to clear the global enviroment of all variables
df_clean %>% write_csv("smoking_data.csv")
# rm(list = ls(all = TRUE))
```

<br>

# Part 2 - Data visualization and statistics.

<br>

#### The cleaned data can be retreived from the GitHub repository at https://raw.githubusercontent.com/peter-ehmann/Data_Wrangling_Project_S2019/master/smoking_data.csv.

```{r import_clean_data, message = FALSE}
(
data <- read_csv("https://raw.githubusercontent.com/peter-ehmann/Data_Wrangling_Project_S2019/master/smoking_data.csv")
  )
```

<br>

#### Display information about the packages used, their versions, and the version of R that was used.

```{r sessionInfo}
devtools::session_info()
```
